/*!
 * fileLogger
 * Copyright 2016 Peter Bakondy https://github.com/pbakondy
 * See LICENSE in this repository for license information
 */
!function(){angular.module("fileLogger",["ngCordova.plugins.file"]).factory("$fileLogger",["$q","$window","$cordovaFile","$timeout","$filter",function(e,o,r,n,t){"use strict";function i(){return o.parent&&o.parent.ripple}function l(){return!o.cordova&&!o.PhoneGap&&!o.phonegap||i()}function a(e){angular.isString(e)?(e=e.toUpperCase(),k.indexOf(e)===-1&&(e="INFO")):e="INFO";for(var o,r=new Date,n=F?t("date")(r,F,j):r.toJSON(),i=Array.prototype.slice.call(arguments,1),a=[n,e],s=0;s<i.length;s++)if(angular.isArray(i[s])){o="[Array]";try{o=JSON.stringify(i[s])}catch(f){}a.push(o)}else if(angular.isObject(i[s])){o="[Object]";try{o=JSON.stringify(i[s])}catch(f){}a.push(o)}else a.push(i[s]);if(l()){if(i.unshift(n),angular.isObject(console)&&angular.isFunction(console.log))switch(e){case"DEBUG":angular.isFunction(console.debug)?console.debug.apply(console,i):console.log.apply(console,i);break;case"INFO":angular.isFunction(console.debug)?console.info.apply(console,i):console.log.apply(console,i);break;case"WARN":angular.isFunction(console.debug)?console.warn.apply(console,i):console.log.apply(console,i);break;case"ERROR":angular.isFunction(console.debug)?console.error.apply(console,i):console.log.apply(console,i);break;default:console.log.apply(console,i)}}else console.log(a.join(" "));D.push({message:a.join(" ")+"\n"}),O||c()}function c(){if(!D.length)return void(O=!1);O=!0;var e=D.shift();s(e.message).then(function(){n(function(){c()})},function(){n(function(){c()})})}function s(n){var t=e.defer();if(l())o.localStorage[R]||(o.localStorage[R]=""),o.localStorage[R]+=n,t.resolve();else{if(!o.cordova||!o.cordova.file||!o.cordova.file.dataDirectory)return t.reject("cordova.file.dataDirectory is not available"),t.promise;angular.isString(A)&&A.length>0&&(console.log("before check dir, folder:",A),r.checkDir(w,A).then(function(e){console.log("check dir success")},function(e){console.log("check dir failed"),r.createDir(w,A,!0).then(function(e){console.log("create dir success")},function(e){console.log("create dir failed")})})),console.log("before check file with folder:",w+A+"/"),r.checkFile(w+A+"/",R).then(function(){console.log("check file success"),r.writeExistingFile(w+A+"/",R,n).then(function(){t.resolve()},function(e){t.reject(e)})},function(){console.log("check file failed"),r.writeFile(w+A+"/",R,n,!0).then(function(){t.resolve()},function(e){t.reject(e)})})}return t.promise}function f(){var n=e.defer();if(l())n.resolve(o.localStorage[R]);else{if(!o.cordova||!o.cordova.file||!o.cordova.file.dataDirectory)return n.reject("cordova.file.dataDirectory is not available"),n.promise;r.readAsText(w+A+"/",R).then(function(e){n.resolve(e)},function(e){n.reject(e)})}return n.promise}function u(){var n=e.defer();if(l())o.localStorage.removeItem(R),n.resolve();else{if(!o.cordova||!o.cordova.file||!o.cordova.file.dataDirectory)return n.reject("cordova.file.dataDirectory is not available"),n.promise;r.removeFile(w+A+"/",R).then(function(e){n.resolve(e)},function(e){n.reject(e)})}return n.promise}function g(e){return!!(angular.isString(e)&&e.length>0)&&(R=e,!0)}function d(e){return!!(angular.isString(e)&&e.length>0)&&(w=e,!0)}function p(e){return!!(angular.isString(e)&&e.length>0)&&(A=e,!0)}function v(e,o){if(!angular.isUndefined(e)&&!angular.isString(e))throw new TypeError("format parameter must be a string or undefined");if(!angular.isUndefined(o)&&!angular.isString(o))throw new TypeError("timezone parameter must be a string or undefined");F=e,j=o}function h(){var n=e.defer();if(l())n.resolve({name:R,localURL:"localStorage://localhost/"+R,type:"text/plain",size:o.localStorage[R]?o.localStorage[R].length:0});else{if(!o.cordova||!o.cordova.file||!o.cordova.file.dataDirectory)return n.reject("cordova.file.dataDirectory is not available"),n.promise;r.checkFile(w+A+"/",R).then(function(e){e.file(n.resolve,n.reject)},n.reject)}return n.promise}function y(){var e=Array.prototype.slice.call(arguments,0);e.unshift("DEBUG"),a.apply(void 0,e)}function m(){var e=Array.prototype.slice.call(arguments,0);e.unshift("INFO"),a.apply(void 0,e)}function b(){var e=Array.prototype.slice.call(arguments,0);e.unshift("WARN"),a.apply(void 0,e)}function S(){var e=Array.prototype.slice.call(arguments,0);e.unshift("ERROR"),a.apply(void 0,e)}var F,j,D=[],O=!1,k=["DEBUG","INFO","WARN","ERROR"],R="messages.log",w=cordova.file.dataDirectory,A="";return{log:a,getLogfile:f,deleteLogfile:u,setStorageFilename:g,setStorageRootFolder:d,setStorageSubFolder:p,setTimestampFormat:v,checkFile:h,debug:y,info:m,warn:b,error:S}}])}();